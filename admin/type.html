<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<link rel="stylesheet" />
		<link rel="stylesheet" href="css/Site.css" />
		<link rel="stylesheet" href="css/zy.all.css" />
		<link rel="stylesheet" href="css/font-awesome.min.css" />
		<link rel="stylesheet" href="css/amazeui.min.css" />
		<link rel="stylesheet" href="css/admin.css" />
		<style>
			.shuju {
				height: 50px;
				line-height: 50px;
				margin: 15px 0;
			}
			
			.shuju ul {
				height: 50px;
			}
			
			.shuju li select {
				display: inline-block;
				width: 90px;
				height: 25px;
				line-height: 25px;
				font-size: 14px;
			}
			
			.shuju li label {
				line-height: 30px;
			}
			
			.shuju li {
				list-style: none;
				float: left;
				margin-right: 50px;
			}
			
			.shuju li .allnum {
				margin: 0 15px;
			}
		</style>

		<body>
			<div class="dvcontent">

				<div>
					<!--tab start-->
					<div class="tabs">
						<div class="hd">
							<ul style="">
								<li style="box-sizing: initial;-webkit-box-sizing: initial;" class="on">查看分类</li>
								<li class="" style="box-sizing: initial;-webkit-box-sizing: initial;">添加分类</li>

							</ul>
						</div>

						<div class="bd">
							<ul style="display: block;padding: 20px;">
								<li>
									<div class="shuju">
										<ul>
											<li>
												<label>选择分类
										<select name="" id="select1">
											<option value="">全部</option>
											<!--<option value="">肉类</option>
											<option value="">蔬菜</option>
											<option value="">水果</option>
											<option value="">调料</option>
											<option value="">海鲜</option>
											<option value="">奶制品</option>
											<option value="">豆制品</option>
											<option value="">蛋禽</option>-->
										</select>
									</label>
											</li>
											<li>从当前数据中检索
												<input type="" name="" id="search" />
												<button id="sbtn">查询</button>
											</li>
											<li>共有数据<span class="allnum">6</span>条</li>
										</ul>
									</div>
									<!--分页显示角色信息 start-->
									<div id="dv1">
										<table class="table" id="tbRecord">
											<thead>
												<tr>
													<th>分类编号</th>
													<th>分类名称</th>
													<th>图片</th>
													<th>分类描述</th>
													<th>备注</th>
													<th>编辑</th>
													<th>删除</th>
												</tr>
											</thead>
											<tbody>
												<!--<tr>
												<td>1</td>
												<td>肉类</td>
												<td> </td>
												<td> </td>
												<td> </td>
												<td class="edit"><button onclick="btn_edit(1)"><i class="icon-edit bigger-120"></i>编辑</button></td>
												<td class="delete"><button onclick="btn_delete(1)"><i class="icon-trash bigger-120"></i>删除</button></td>
											</tr>-->

											</tbody>

										</table>
									</div>
									<!--分页显示角色信息 end-->
									<div>
										<button onclick="goPage('first')">首页</button>
										<button onclick="goPage('prev')">上一页</button>
										<span id="gjy">3/4</span>
										<input type="number" name="" id='jump'>
										<button onclick="goPage('jump')">go</button>
										<button onclick="goPage('next')">下一页</button>
										<button onclick="goPage('last')">尾页</button>
									</div>
								</li>
							</ul>
							<ul class="theme-popbod dform" style="display: none;">
								<div class="am-cf admin-main" style="padding-top: 0px;">
									<!-- content start -->

									<div class="am-cf admin-main" style="padding-top: 0px;">
										<!-- content start -->
										<div class="admin-content">
											<div class="admin-content-body">

												<div class="am-g">
													<div class="am-u-sm-12 am-u-md-4 am-u-md-push-8">

													</div>
													<div class="am-u-sm-12 am-u-md-8 am-u-md-pull-4" style="padding-top: 30px;">
														<div class="am-form am-form-horizontal" action="" method="">
															<div class="am-form-group">
																<label for="user-name" class="am-u-sm-3 am-form-label">
									分类名称</label>
																<div class="am-u-sm-9">
																	<input type="text" id="classify_name" required placeholder="分类名称" name="name">
																	<small>10字以内...</small>
																</div>
															</div>
															<div class="am-form-group">
																<label for="user-name" class="am-u-sm-3 am-form-label">
									分类描述</label>
																<div class="am-u-sm-9">
																	<input type="text" id="classify_desc" required placeholder="分类描述" name="name">
																	<small>10字以内...</small>
																</div>
															</div>
															<div class="am-form-group">
																<label for="user-intro" class="am-u-sm-3 am-form-label">
									备注</label>
																<div class="am-u-sm-9">
																	<textarea class="" rows="5" id="classify_info" name="remark" placeholder="输入备注"></textarea>
																	<small>250字以内...</small>
																</div>
															</div>
															<div class="am-form-group">
																<div class="am-u-sm-9 am-u-sm-push-3">
																	<form enctype="multipart/form-data" method="post">
																		<input type="file" name='image' id="imagelist">

																	</form>
																	<img src="" id="tmpimg">
																	<button id='filebtn'> 上传</button>
																</div>
															</div>
															<div class="am-form-group">
																<div class="am-u-sm-9 am-u-sm-push-3">
																	<button id="addbtn" class="btn btn-primary radius" type="submit"><i class="Hui-iconfont">&#xe632;</i> 提交</button>

																	<button onClick="layer_close();" class="btn btn-default radius" type="button">&nbsp;&nbsp;取消&nbsp;&nbsp;</button>
																</div>
															</div>
														</div>
													</div>
												</div>
											</div>

										</div>
										<!-- content end -->
									</div>
									<!-- end-->
							</ul>
							</div>
						</div>
						<!--tab end-->
					</div>
				</div>

				<script src="js/jquery-1.7.2.min.js" type="text/javascript"></script>
				<script src="js/plugs/Jqueryplugs.js" type="text/javascript"></script>
				<script src="js/_layout.js"></script>
				<script src="js/plugs/jquery.SuperSlide.source.js"></script>
				<script>
					//选项卡点击跳转
					$(function() {

						$(".tabs").slide({
							trigger: "click"
						});

					});

					//己方代码

					let rootapi = 'http://localhost:3008/'
					//切记存相对路径
					// 获取layout数据的封装
					let total = 0; //总共几条数据
					let qty = 5; //一页显示5条数据
					let allPage = 0; //总页数
					let nowPage = 1; //当前页

					//分页效果
					function goPage(type) { //type参数为case值
						var targetPage = 1;
						switch(type) {
							case 'prev':
								targetPage = nowPage > 1 ? nowPage - 1 : 1

								break;
							case 'next':
								//targetPage = nowPage < allPage ? nowPage + 1 : allPage
								if(nowPage >= allPage) {
									targetPage = allPage;
									alert('当前页是最后一页了');
								} else {
									targetPage = nowPage + 1;
								}

								break;
							case 'first':
								targetPage = 1

								break;
							case 'last':
								targetPage = allPage;

								break;
							case 'jump':
								targetPage = $('#jump').val();
								if(targetPage <= allPage) {

								} else {
									targetPage = allPage;
									alert('没有更多了');
								}
								break;
						}

						nowPage = targetPage; //当前页等于目标页//更新页面
						getlayout(targetPage);
					}

					var name = ''; //name用于分类查询，当传回去的值为为全部或水果等，后端根据name查找数据
					var sear = '';
					getlayout(nowPage);

					function getlayout(page) {
						let data = {
							page: nowPage,
							qty: qty,
							name: name,
							sear: sear
						}
						console.log(name);
						$.post(rootapi + 'api/layout/layoutlist', data, function(res) {
							console.log(res.data.odata); //因为后台用odata接data
							if(res.err == 0) {
								Create(res.data.odata);
								Createtype(res.data.odata);
								$('.allnum').text(res.data.total);

								total = res.data.total;
								allPage = Math.ceil(total / qty);
								$('#gjy').text(`${nowPage}/${allPage}页`);
							} else {
								alert(res.msg)
							}
						}, 'json')
					}

					//创建节点
					function Create(data) {
						var html = '';
						$('#select1').html('');
						for(var i = 0; i < data.length; i++) {
							html += `<tr>
									<td>${i+1}</td>
									<td>${data[i].name}</td>
									<td><img src='${rootapi}${data[i].img}'></td>
									<td>${data[i].desc}</td>
									<td>${data[i].info}</td>
									<td class="edit"><button id='editone' onClick="edit('${data[i]._id}')"><i class="icon-edit bigger-120"></i>编辑</button></td>
									<td class="delete"><button id='delone' value='${data[i]._id}'><i class="icon-trash bigger-120"></i>删除</button></td>
								</tr>`
						}
						$('#dv1 tbody').html(html);
					}

					//创建分类节点
					function Createtype(typedata) {
						console.log(1111)
						console.log(typedata);
						var str = '';
						for(var i = 0; i < typedata.length; i++) {
							
							 str += `
											<option>${typedata[i].name}</option>
										 `
							$('#select1').append(str);
						}

					}

					//删除操作
					$('#dv1 tbody').on('click', '#delone', function() {
						var id = $(this).attr('value');
						console.log(id);
						let odata = {
							id: id
						};
						var ress = confirm('您确定要删除这条信息吗？');
						if(ress) { //如果确定删除，才执行删除操作
							$.post(rootapi + 'api/layout/dellayout', odata, function(res) {
								if(res.err == 0) {
									alert('删除成功');
									goPage(nowPage);
								} else {
									alert(res.msg);
								}

								$('.allnum').html(html);
							});
						}
					})

					// 文件上传操作
					function Req_ajax() {

						console.log($("#imagelist")[0].files);
						var formData = new FormData(); //创建
						//console.log(formData);
						// console.log(formData.get('name'))//通过get获取formdata 值
						formData.append("test", $("#imagelist")[0].files[0])
						console.log(formData.get("test"));
						$.ajax({
							url: rootapi + 'api/upload/img',
							type: 'POST',
							data: formData,
							cache: false,
							contentType: false,
							processData: false,
							success: function(data) {
								if(data.err == 0) {
									$('img').attr('src', 'http://localhost:3008/' + data.path)
									uploaded = data.path;
								}
							}
						});
					}
					$('#filebtn').on('click', Req_ajax);

					//添加菜品操作
					function addclassify() {
						if(uploaded) {
							var classifydata = {
								name: $('#classify_name').val(),
								img: uploaded,
								desc: $('#classify_desc').val(),
								info: $('#classify_info').val(),
							}
							console.log(classifydata);
							$.post(rootapi + "api/layout/addclassify", classifydata, function(res) {
								if(res.err == 0) {
									//数据添加成功后会进入数据库，数据库有多少数据就都会渲染出来
									alert('添加成功');
								} else {
									alert(res.msg);
								}
							})
						} else {
							alert('请先上传图片');
						}

					}
					$('#addbtn').on('click', addclassify);

					//修改	
					function edit(id) {
						//存储修改的商品编号
						var storage = window.localStorage;
						storage.setItem('updateid', id); //将id存入storage
						location.href = 'edit.html?' + id; //将id传给修改页面
						//localstorage 存储数据
					}

					//分类查询
					$('#select1').on('click', function() {
						name = $('#select1 option:selected').text(); //拿到选中的下拉菜单值（更新name值）
						getlayout(nowPage); //调用函数
						if(name == '全部') {
							name = ''; //name为空，走默认
							getlayout(nowPage); //刷新当前页
						}

					});
					//模糊查询
					$('#sbtn').click(function() {
						sear = $('#search').val();
						//console.log(sear);
						getlayout(nowPage);
					})
				</script>

		</body>

</html>